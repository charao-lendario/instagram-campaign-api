# Story 2.8: Strategic Insights View

## Status: InProgress

## Epic: EPIC-2 - Frontend Dashboard
## Story Points: 3

---

## Story

**As a** campaign strategist,
**I want** to see AI-generated strategic suggestions backed by real engagement data,
**so that** I can make informed, data-driven decisions about campaign messaging and positioning without manually interpreting raw analytics.

**PRD References**: FR-012

---

## Acceptance Criteria

- [x] AC1: Given the `/insights` page loads, when data is available (suggestions fetched on page mount), then 3 to 5 suggestion cards are rendered, each in a shadcn `Card` with a distinctive left-side colored border indicating priority.
- [x] AC2: Given each suggestion card, when rendered, then it displays: title (bold, larger text), description (paragraph), supporting_data text (in a visually distinct `<blockquote>` or highlighted box with an info icon), and a priority `Badge` (red "Alta" for `high`, yellow "Media" for `medium`, green "Baixa" for `low`).
- [x] AC3: Given the priority border, when a card is rendered with `priority === "high"`, then the left border is red (`border-l-4 border-red-500`); `"medium"` renders yellow (`border-l-4 border-yellow-500`); `"low"` renders green (`border-l-4 border-green-500`).
- [x] AC4: Given a "Atualizar sugestoes" button at the top of the page, when clicked, then `POST /api/v1/analytics/suggestions` is called with the current `candidate_id` filter (or no body if "all" is selected), and the cards re-render with the new suggestions.
- [x] AC5: Given the "Atualizar sugestoes" button is clicked, when the LLM call is in progress (may take 3-10 seconds), then the button is disabled, shows a spinning `Loader2` icon from lucide-react, and the cards area shows a loading overlay or skeleton.
- [x] AC6: Given the `CandidateFilter` in the header, when a specific candidate is selected, then the `candidate_id` is included in the suggestions request body on the next refresh. On initial page load, the current filter value is used.
- [x] AC7: Given a disclaimer below the suggestion cards, when rendered, then the text "Sugestoes geradas por IA com base nos dados disponiveis. Valide com a equipe de campanha antes de agir." is visible in small gray text.
- [x] AC8: Given data is loading on page mount, when `loading: true`, then 3-5 skeleton cards with the shape of suggestion cards render as placeholders.
- [x] AC9: Given an API error (including LLM provider failure), when the suggestions request fails, then the shared `ErrorMessage` component renders with the message "Nao foi possivel gerar sugestoes. Tente novamente." and a retry button.
- [x] AC10: Given no data exists yet (API returns empty suggestions array or error due to insufficient data), when the empty state renders, then `EmptyState` shows "Dados insuficientes para gerar sugestoes. Execute uma coleta de dados primeiro." with a button to trigger scraping.
- [x] AC11: Given the page layout, when rendered, then the suggestions cards are ordered by priority (high first, medium second, low last) regardless of the order returned by the API.
- [x] AC12: Given the tab navigation, when the user navigates to `/insights`, then this is the 7th and final tab ("Insights") and all previous tabs remain functional.

---

## Scope

### IN
- `/insights` page (`src/app/insights/page.tsx`)
- `SuggestionCard` component (`src/components/dashboard/suggestion-card.tsx`)
- Priority sorting logic (client-side)
- Priority label localization (high->Alta, medium->Media, low->Baixa)
- "Atualizar sugestoes" button with loading state
- CandidateFilter integration for scoping suggestions
- `useSuggestions` hook integration (from Story 2.2)
- Disclaimer text

### OUT
- Saving or persisting suggestions to local storage or DB
- Sharing suggestions via email/PDF export
- User rating of suggestions
- History of past suggestion batches
- Auto-refresh on a schedule

---

## Dependencies

- Story 2.1 complete (layout, CandidateFilter, shadcn Button, Card, Badge, Skeleton)
- Story 2.2 complete (`useSuggestions`, `fetchSuggestions`, `SuggestionsResponse`/`Suggestion` types, `ErrorMessage`, `LoadingSkeleton`, `EmptyState`)
- Lucide React already installed (Story 2.7)
- All Stories 2.1-2.7 complete (this is the final view in the navigation)

---

## Technical Notes

### API Endpoint

`POST /api/v1/analytics/suggestions`

Request body (optional):
```json
{ "candidate_id": "uuid" }
```
Or empty body `{}` for all candidates.

Response shape (from architecture.md section 3.2.5):
```json
{
  "suggestions": [
    {
      "title": "Explorar tema de saude com mais frequencia",
      "description": "Posts do candidato sobre saude geram 40% mais engajamento positivo que a media.",
      "supporting_data": "Charlles: 52 comentarios sobre saude (82% positivos) vs Sheila: 35 (61% positivos)",
      "priority": "high"
    }
  ],
  "generated_at": "2026-02-21T15:30:00Z",
  "data_snapshot": {
    "total_comments_analyzed": 1010,
    "last_scrape": "2026-02-21T14:00:00Z"
  }
}
```

### useSuggestions Hook Behavior

The `useSuggestions` hook from Story 2.2 was designed as a POST hook (not a GET). It should:
- On mount: trigger a POST request automatically (fetch on load)
- Expose a `refetch(candidateId?: string)` function for the refresh button
- Manage loading, error, and data states

If the hook was implemented as a GET wrapper in Story 2.2, the dev agent should adapt it to handle POST with optional body.

### SuggestionCard Component

```typescript
// src/components/dashboard/suggestion-card.tsx
interface SuggestionCardProps {
  suggestion: Suggestion   // from src/lib/types.ts
}
```

Priority border classes:
```typescript
const borderClass = {
  high: 'border-l-4 border-red-500',
  medium: 'border-l-4 border-yellow-500',
  low: 'border-l-4 border-green-500',
}[suggestion.priority]
```

Priority badge variants:
```typescript
const badgeLabel = { high: 'Alta', medium: 'Media', low: 'Baixa' }[suggestion.priority]
const badgeClass = {
  high: 'bg-red-100 text-red-800',
  medium: 'bg-yellow-100 text-yellow-800',
  low: 'bg-green-100 text-green-800',
}[suggestion.priority]
```

Supporting data display — use a subtle highlight box:
```tsx
<div className="bg-slate-50 border border-slate-200 rounded p-3 text-sm text-slate-700 flex gap-2">
  <InfoIcon className="h-4 w-4 mt-0.5 text-slate-400 shrink-0" />
  <span>{suggestion.supporting_data}</span>
</div>
```

### Priority Sorting (AC11)

```typescript
const PRIORITY_ORDER = { high: 0, medium: 1, low: 2 }

const sortedSuggestions = [...suggestions].sort(
  (a, b) => PRIORITY_ORDER[a.priority] - PRIORITY_ORDER[b.priority]
)
```

### Refresh Button Pattern (AC4, AC5)

```typescript
const [refreshing, setRefreshing] = useState(false)

const handleRefresh = async () => {
  setRefreshing(true)
  try {
    await refetch(candidateId)  // from useSuggestions hook
  } finally {
    setRefreshing(false)
  }
}
```

```tsx
<Button onClick={handleRefresh} disabled={refreshing}>
  {refreshing
    ? <><Loader2 className="h-4 w-4 mr-2 animate-spin" /> Gerando...</>
    : 'Atualizar sugestoes'
  }
</Button>
```

`Loader2` from `lucide-react` with `animate-spin` Tailwind class produces the standard spinning loader.

### Page Structure

```
src/app/insights/page.tsx (Client Component)
  Header area:
    <h1>Insights Estrategicos</h1>
    <Button onClick={handleRefresh}>Atualizar sugestoes</Button>
    <p>data_snapshot: total_comments_analyzed, last generated_at</p>

  Content area (conditional):
    loading: <3-5 LoadingSkeleton variant="card" />
    error: <ErrorMessage error={error} onRetry={refetch} />
    empty: <EmptyState ... trigger scraping />
    data: sorted SuggestionCards

  Footer area:
    <p className="text-xs text-muted-foreground mt-8">
      Sugestoes geradas por IA com base nos dados disponiveis. Valide com a equipe de campanha antes de agir.
    </p>
```

### Last-Generated Timestamp Display

Show below the button: "Gerado em: DD/MM/YYYY HH:mm" using the `formatDate` utility from Story 2.3.

### CandidateFilter for Suggestions (AC6)

When the user has a candidate selected in the URL param, include it in the refresh POST body. On initial load, the hook uses the current filter value.

---

## Tasks / Subtasks

- [x] T1: Create SuggestionCard component (AC1, AC2, AC3)
  - [x] T1.1: Create `src/components/dashboard/suggestion-card.tsx`
  - [x] T1.2: Implement priority border class logic
  - [x] T1.3: Implement priority badge with localized labels (Alta/Media/Baixa)
  - [x] T1.4: Style supporting_data as a highlighted info box with InfoIcon

- [x] T2: Build insights page (AC1, AC4, AC5, AC6, AC7, AC8, AC9, AC10, AC11, AC12)
  - [x] T2.1: Convert `/insights` placeholder to Client Component
  - [x] T2.2: Wire `useSuggestions` hook for initial load
  - [x] T2.3: Implement priority sorting on received suggestions
  - [x] T2.4: Implement "Atualizar sugestoes" button with Loader2 spinner
  - [x] T2.5: Add CandidateFilter integration (pass candidate_id to refresh)
  - [x] T2.6: Add last-generated timestamp display
  - [x] T2.7: Implement loading state (3 skeleton cards)
  - [x] T2.8: Implement error state with retry
  - [x] T2.9: Implement empty state with trigger scraping button
  - [x] T2.10: Add disclaimer text at bottom

- [x] T3: Navigation verification (AC12)
  - [x] T3.1: Confirm "Insights" is the 7th tab in nav-tabs.tsx
  - [x] T3.2: Confirm all 7 tabs navigate correctly with active state
  - [x] T3.3: Run `pnpm build` to confirm zero TypeScript/lint errors across the entire project

---

## Dev Notes

### Testing
- No automated tests required for this story
- Final manual testing checklist for the complete Epic 2:
  - All 7 tabs navigate without errors
  - Insights page loads suggestions on mount
  - Priority colors correct (red/yellow/green borders and badges)
  - Suggestions sorted high->medium->low
  - Refresh button triggers new LLM generation with spinner
  - Disclaimer text visible below cards
  - CandidateFilter scopes suggestions to selected candidate
  - Loading, error, and empty states all work
  - `pnpm build` passes with zero errors across the full project

### Notes from Architecture
- The suggestions endpoint is `POST /api/v1/analytics/suggestions` (not GET). This is unique among dashboard endpoints — all others are GET. The `useSuggestions` hook must send a POST request.
- LLM generation can take 5-15 seconds (architecture.md section 6.3). The "Gerando..." loading state on the button is important UX for this latency.
- The `fetchSuggestions` function in `src/lib/api.ts` (Story 2.2) should use `method: 'POST'` and include `Content-Type: application/json` header.
- The `data_snapshot.total_comments_analyzed` and `generated_at` from the response are metadata context — display them as secondary info near the button so the user knows how fresh the suggestions are.
- Priority badge values from the API are English strings (`"high"`, `"medium"`, `"low"`). The frontend maps them to Portuguese display labels (`"Alta"`, `"Media"`, `"Baixa"`). Do not change the API contract.
- This is story 2.8, the final story of Epic 2. The `pnpm build` check in T3.3 serves as the Epic 2 completion gate.

---

## Risks

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| LLM generation latency (5-15 seconds) causes poor UX | High | Medium | AC5 addresses this with disabled button, Loader2 spinner, and "Gerando..." text. Loading overlay on cards area. |
| LLM provider failure returns no suggestions | Medium | High | AC9 provides error state with retry button. Architecture.md notes this is an external dependency. Backend should return clear error messages. |
| Suggestions POST endpoint behavior unclear (fetch on load vs manual only) | Medium | Medium | Technical notes clarify: auto-fetch on mount + manual refetch. useSuggestions hook handles both patterns. |
| Empty state when no data collected yet requires clear user guidance | Low | Medium | AC10 provides specific messaging and a button to trigger scraping. Links back to the scraping pipeline. |
| Priority sorting assumption (API may return already sorted) | Low | Low | Client-side sorting (AC11) guarantees order regardless of API response order. No performance concern with 3-5 items. |

---

## Validation

| Field | Value |
|-------|-------|
| **Validated by** | Pax (PO Agent) |
| **Validation date** | 2026-02-22 |
| **Score** | 9/10 |
| **Verdict** | GO |
| **Failed items** | #8 Risks (added during validation) |
| **Notes** | Final story of Epic 2. T3 includes pnpm build as Epic 2 completion gate. POST endpoint correctly identified (unique among dashboard endpoints). Portuguese disclaimer text is appropriate for target audience. |

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `src/components/dashboard/suggestion-card.tsx` | Created | SuggestionCard with priority borders, badges, info box |
| `src/app/insights/page.tsx` | Modified | Server Component wrapper with Suspense boundary |
| `src/app/insights/insights-content.tsx` | Created | Client Component with refresh, sorting, loading/error/empty states, disclaimer |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story created | River (SM Agent) |
| 2026-02-22 | 1.1 | Validated GO 9/10. Added Risks and Validation sections. Status Draft -> Ready. | Pax (PO Agent) |
| 2026-02-22 | 1.2 | Implementation complete. All ACs met. Build passes clean. Status Ready -> InProgress. | Dex (Dev Agent) |
