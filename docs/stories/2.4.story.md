# Story 2.4: Sentiment Timeline Chart

## Status: InProgress

## Epic: EPIC-2 - Frontend Dashboard
## Story Points: 5

---

## Story

**As a** campaign strategist,
**I want** a line chart showing how average sentiment score evolves over time for each candidate,
**so that** I can identify trends and correlate sentiment shifts with specific post topics or external events.

**PRD References**: FR-007

---

## Acceptance Criteria

- [x] AC1: Given the `/sentiment` page loads with data, when `useSentimentTimeline()` returns data points, then a Recharts `LineChart` renders with: X-axis showing post timestamps formatted as "DD/MM", Y-axis ranging from -1.0 to 1.0 representing average sentiment compound score, and one line per candidate colored using the candidate CSS variables (`--color-candidate-a` for charlles, `--color-candidate-b` for delegadasheila).
- [x] AC2: Given the line chart is rendered, when a user hovers over a data point, then a Recharts `Tooltip` appears showing: date (formatted "DD/MM/YYYY"), candidate name, sentiment score (2 decimal places), and post caption truncated to 60 characters.
- [x] AC3: Given the chart, when rendered, then a horizontal `ReferenceLine` at y=0 with a dashed style separates positive territory (above) from negative territory (below).
- [x] AC4: Given a Recharts `Legend` is rendered, when the chart shows both candidates, then the legend labels match the candidate display names and use the correct candidate colors.
- [x] AC5: Given date range inputs at the top of the page, when the user selects a start date and/or end date, then the `useSentimentTimeline` hook is called with the new date parameters and the chart re-renders with filtered data.
- [x] AC6: Given the date range controls, when the page first loads, then the default range is the last 30 days (start = today minus 30 days, end = today).
- [x] AC7: Given the `CandidateFilter` in the header, when a single candidate is selected, then only that candidate's line is shown in the chart (the other line is removed from the dataset passed to Recharts).
- [x] AC8: Given the chart container, when the browser window is resized, then the chart width adapts responsively using Recharts `ResponsiveContainer` with `width="100%"`.
- [x] AC9: Given data is loading, when `useSentimentTimeline()` returns `loading: true`, then a skeleton placeholder in the shape of a chart area (rectangular shimmer, approximately 400px tall) renders in place of the chart.
- [x] AC10: Given no data points exist for the selected date range, when the hook returns an empty `data_points` array, then the `EmptyState` component renders with "Nenhum dado para o periodo selecionado."

---

## Scope

### IN
- `/sentiment` page (`src/app/sentiment/page.tsx`) â€” Client Component
- `SentimentLineChart` component (`src/components/charts/sentiment-line.tsx`)
- Date range picker UI (two `<input type="date">` fields)
- CandidateFilter integration (URL search params from Story 2.1)
- Integration of `useSentimentTimeline` hook (from Story 2.2)

### OUT
- Click-through to individual post detail (not in scope for MVP)
- Animated chart transitions
- Export to image/CSV
- Zoom or pan on the chart

---

## Dependencies

- Story 2.1 complete (layout, CandidateFilter)
- Story 2.2 complete (`useSentimentTimeline` hook, `OverviewData` types, `LoadingSkeleton`, `EmptyState`)
- Recharts must be installed: `pnpm add recharts`

---

## Technical Notes

### API Endpoint

`GET /api/v1/analytics/sentiment-timeline`

Query parameters:
- `candidate_id` (optional UUID): filter to one candidate
- `start_date` (optional ISO date string: `YYYY-MM-DD`): start of range
- `end_date` (optional ISO date string: `YYYY-MM-DD`): end of range

Response shape (from architecture.md section 3.2.4):
```json
{
  "data_points": [
    {
      "candidate_id": "uuid",
      "candidate_username": "charlles.evangelista",
      "post_id": "uuid",
      "post_url": "https://instagram.com/p/abc123",
      "post_caption": "Hoje visitamos o bairro...",
      "posted_at": "2026-02-15T10:30:00Z",
      "average_sentiment_score": 0.23,
      "comment_count": 45
    }
  ]
}
```

### Recharts Components to Use

```typescript
import {
  ResponsiveContainer, LineChart, Line,
  XAxis, YAxis, CartesianGrid, Tooltip,
  Legend, ReferenceLine
} from 'recharts'
```

### Data Transformation

The API returns a flat array of data points across both candidates. Recharts `LineChart` with multiple `Line` components requires data keyed by date with a value per candidate. Transform:

```typescript
// Group by posted_at date, create one row per date with values for each candidate
interface ChartDataPoint {
  date: string                      // "DD/MM" for XAxis display
  dateISO: string                   // full ISO for tooltip
  caption: string                   // for tooltip
  charlles_evangelista?: number     // sentiment score
  delegadasheila?: number
}
```

Since each data point is a post (not a day), and two candidates can post on different days, pivot by post rather than by calendar date. Each row in the chart data represents one post, identified by `posted_at`.

[AUTO-DECISION] Use per-post data points (not aggregated by day) because the API already returns one point per post and aggregating by day would lose post-caption context needed for the tooltip. Each post is one X-axis tick.

### Component: SentimentLineChart

```typescript
// src/components/charts/sentiment-line.tsx
'use client'

interface SentimentLineChartProps {
  dataPoints: TimelineDataPoint[]
  candidateFilter: 'all' | 'charlles' | 'sheila'
}
```

- Build the chart data array from `dataPoints`
- Render two `<Line>` components, one per candidate
- Apply `stroke={CANDIDATE_A_COLOR}` and `stroke={CANDIDATE_B_COLOR}` from `src/lib/constants.ts`
- Use `dot={false}` for a clean line without dots cluttering the chart
- Set `activeDot={{ r: 6 }}` for hover interaction

### Date Range Controls

Simple implementation with two native `<input type="date">` wrapped in a Card:
```typescript
const [startDate, setStartDate] = useState(() => {
  const d = new Date()
  d.setDate(d.getDate() - 30)
  return d.toISOString().split('T')[0]  // YYYY-MM-DD
})
const [endDate, setEndDate] = useState(() => new Date().toISOString().split('T')[0])
```

[AUTO-DECISION] Use native `<input type="date">` instead of a shadcn date picker. Reason: shadcn date picker requires additional setup (react-day-picker dependency) and the native input is sufficient for MVP per epic dev notes.

### Tooltip Formatter

```typescript
const CustomTooltip = ({ active, payload, label }: TooltipProps) => {
  if (!active || !payload?.length) return null
  return (
    <div className="bg-white border rounded p-3 shadow text-sm">
      <p className="font-semibold">{label}</p>
      {payload.map((entry) => (
        <p key={entry.dataKey} style={{ color: entry.color }}>
          {entry.name}: {Number(entry.value).toFixed(2)}
        </p>
      ))}
    </div>
  )
}
```

The post caption is available in the data row but Recharts tooltip only receives what is in the data array. Include `caption` in the chart data object and display it in the custom tooltip.

### Y-Axis Configuration

```typescript
<YAxis domain={[-1, 1]} tickCount={5} tickFormatter={(v) => v.toFixed(1)} />
```

### X-Axis Formatting

```typescript
<XAxis
  dataKey="date"
  tickFormatter={(value) => value}  // already formatted as DD/MM
/>
```

---

## Tasks / Subtasks

- [x] T1: Install Recharts (if not already installed)
  - [x] T1.1: `pnpm add recharts` (already installed from Story 2.1)
  - [x] T1.2: Verify types are available (recharts ships with its own types)

- [x] T2: Create SentimentLineChart component (AC1, AC2, AC3, AC4, AC8)
  - [x] T2.1: Create `src/components/charts/sentiment-line.tsx`
  - [x] T2.2: Implement data transformation (flat array to chart-ready format)
  - [x] T2.3: Build Recharts structure with ResponsiveContainer, two Lines, ReferenceLine
  - [x] T2.4: Add custom Tooltip showing date, candidate, score, caption

- [x] T3: Build sentiment page (AC5, AC6, AC7, AC9, AC10)
  - [x] T3.1: Convert `/sentiment` placeholder to Client Component page
  - [x] T3.2: Add date range inputs with 30-day default
  - [x] T3.3: Wire `useSentimentTimeline` hook with date and candidate params
  - [x] T3.4: Implement loading state (chart skeleton)
  - [x] T3.5: Implement empty state with message
  - [x] T3.6: Pass `candidateFilter` prop to SentimentLineChart for line filtering

- [x] T4: CandidateFilter integration (AC7)
  - [x] T4.1: Read `candidate` search param from URL
  - [x] T4.2: Pass as `candidateId` to `useSentimentTimeline` via getCandidateId utility

---

## Dev Notes

### Testing
- No automated tests required for this story
- Manual testing checklist:
  - Chart renders with both lines using correct colors
  - Reference line at y=0 visible with dashed style
  - Hovering a point shows tooltip with caption
  - Changing date range re-fetches and updates chart
  - CandidateFilter hides one line when single candidate selected
  - Chart responsive at 768px and 1024px
  - Empty state shown when no data in range

### Notes from Architecture
- Recharts is the sole charting library (CON-004). Do not add any other chart library.
- The `candidate_id` parameter for the timeline API is a UUID, not the username string. The frontend needs to resolve the username from the CandidateFilter selection to the candidate_id UUID. Use the data returned by `useOverview()` (available from Story 2.3) to get the UUID for each candidate username. Alternatively, the page can fetch the overview data once on mount to get the candidate IDs.
- [AUTO-DECISION] For candidate UUID resolution: fetch overview once on mount using `fetchOverview()` directly (not the hook, to avoid duplicate state) to get the `candidate_id` values. Cache them in a `useRef` to avoid repeated calls.
- `ResponsiveContainer` requires the parent element to have a defined height. Set a fixed height on the container div: `<div style={{ height: 400 }}>`.
- The API filters by `candidate_id` (UUID). When "all" is selected, omit the `candidate_id` param entirely.

---

## Risks

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Recharts bundle size increases initial page load time | Medium | Low | Recharts supports tree-shaking; only import used components. Monitor bundle with `next build` analyzer |
| Data transformation (flat array to per-post pivot) may produce unexpected results with overlapping timestamps | Low | Medium | Test with edge cases: two candidates posting at the same timestamp, single data point, large datasets |
| Candidate UUID resolution requires overview data fetch on mount -- adds latency | Medium | Low | Cache candidate IDs in `useRef` after first fetch; consider extracting to a shared utility (Story 2.5 has same need) |
| Native `<input type="date">` has inconsistent styling across browsers | Low | Low | Acceptable for MVP per epic dev notes; can be upgraded to shadcn date picker post-MVP |
| Per-post X-axis ticks may become unreadable with many posts (20+ per candidate) | Medium | Medium | Recharts `XAxis` supports `interval` and `angle` props to reduce tick overlap; dev should test with realistic data volume |

---

## Validation

| Date | Validator | Score | Verdict | Notes |
|------|-----------|-------|---------|-------|
| 2026-02-21 | Pax (PO) | 9/10 | GO | Missing Risks section was only failure; added during validation. API contract verified against architecture.md section 3.2.4. Recharts usage compliant with CON-004 |

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `src/components/charts/sentiment-line.tsx` | Created | Recharts LineChart with two lines, custom tooltip, ReferenceLine at y=0 |
| `src/app/sentiment/page.tsx` | Modified | Server Component wrapper with Suspense boundary |
| `src/app/sentiment/sentiment-content.tsx` | Created | Client Component with date range inputs, useSentimentTimeline integration |
| `src/lib/utils.ts` | Modified | Added formatDateShort, formatDateMedium, getCandidateId (shared with Story 2.3) |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story created | River (SM Agent) |
| 2026-02-21 | 1.1 | Validated: GO 9/10. Added Risks and Validation sections. Status Draft -> Ready | Pax (PO Agent) |
| 2026-02-21 | 1.2 | Implementation complete. All ACs met. Build passes. Status Ready -> InProgress | Dex (Dev Agent) |
