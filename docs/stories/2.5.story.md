# Story 2.5: Word Cloud Visualization

## Status: InProgress

## Epic: EPIC-2 - Frontend Dashboard
## Story Points: 3

---

## Story

**As a** campaign strategist,
**I want** a word cloud showing the most frequent words from Instagram comments,
**so that** I can quickly identify which topics and terms the public is discussing about each candidate without reading through thousands of individual comments.

**PRD References**: FR-008, NFR-003

---

## Acceptance Criteria

- [x] AC1: Given the `/words` page loads with data, when `useWordCloud()` returns a word list, then a word cloud visualization renders where the font size of each word is proportional to its frequency count.
- [x] AC2: Given the word cloud is rendered, when viewing the visualization, then at least 50 words are shown (or all available words if fewer than 50 are returned by the API).
- [x] AC3: Given the `CandidateFilter` in the header, when a specific candidate is selected, then the hook re-fetches `GET /api/v1/analytics/wordcloud?candidate_id={id}` and the word cloud re-renders reflecting that candidate's comments only.
- [x] AC4: Given the `CandidateFilter` is set to "All", when the page renders, then the wordcloud reflects comments from both candidates combined (no `candidate_id` param sent).
- [x] AC5: Given the word cloud is rendered, when a user hovers or clicks a word, then a tooltip shows the word and its exact frequency count (e.g., "saude: 87 ocorrencias").
- [x] AC6: Given a subtitle area below the page title, when rendered, then it shows: the currently active filter label ("Todos os candidatos" / "Charlles Evangelista" / "Delegada Sheila") and the total number of unique words returned by the API.
- [x] AC7: Given data is loading, when `useWordCloud()` returns `loading: true`, then a rectangular shimmer skeleton placeholder renders in place of the word cloud.
- [x] AC8: Given an empty word list (no comments yet), when `useWordCloud()` returns an empty `words` array, then the `EmptyState` component renders with "Nenhum comentario coletado ainda."
- [x] AC9: Given the word cloud library is loaded, when the component first renders, then it is loaded via `next/dynamic` with `{ ssr: false }` to avoid hydration errors and reduce initial bundle size.
- [x] AC10: Given the word cloud color palette, when rendered, then words use a multi-color scheme that is visually distinct from the candidate colors (blue and rose) — use a warm/cool mixed palette (e.g., orange, teal, amber, purple tones).

---

## Scope

### IN
- `/words` page (`src/app/words/page.tsx`)
- `WordCloudChart` component (`src/components/charts/word-cloud.tsx`)
- Dynamic import wrapping with SSR disabled
- CandidateFilter integration
- `useWordCloud` hook integration (from Story 2.2)
- Tooltip on word hover/click

### OUT
- Clicking a word to filter comments (not in scope for MVP)
- Animation on word cloud generation
- Custom stop words configuration via UI (stop words are applied server-side by the API per FR-008 and NFR-003)
- Minimum font size / maximum font size controls
- Download word cloud as image

---

## Dependencies

- Story 2.1 complete (layout, CandidateFilter)
- Story 2.2 complete (`useWordCloud` hook, `WordCloudData` type, `LoadingSkeleton`, `EmptyState`)
- Word cloud library must be installed (see Technical Notes for choice)

---

## Technical Notes

### API Endpoint

`GET /api/v1/analytics/wordcloud`

Query parameters:
- `candidate_id` (optional UUID): filter by candidate

Response shape (from architecture.md section 3.2.4):
```json
{
  "words": [
    { "word": "saude", "count": 87 },
    { "word": "seguranca", "count": 65 },
    { "word": "prefeito", "count": 52 }
  ],
  "total_unique_words": 342
}
```

Note: Portuguese stop words are excluded by the API (NFR-003). The frontend does not need to filter words.

### Library Choice

[AUTO-DECISION] Use `react-d3-cloud` (npm package `react-d3-cloud`) instead of `react-wordcloud`. Reason: `react-wordcloud` has a peer dependency conflict with d3 v7+ that causes install issues in Next.js 16. `react-d3-cloud` is a lightweight wrapper around d3-cloud with a simpler API and no peer dep conflicts.

Install: `pnpm add react-d3-cloud`

If `react-d3-cloud` is unavailable or has issues, fallback option is `@visx/wordcloud` from the visx package family.

### Component Structure

```
src/app/words/page.tsx                    (Server Component — passes searchParams)
  src/components/charts/word-cloud.tsx    (Client Component, loaded via next/dynamic)
    dynamically imported to disable SSR
```

### Dynamic Import Pattern (AC9)

```typescript
// src/app/words/page.tsx or in the page's client wrapper
import dynamic from 'next/dynamic'

const WordCloudChart = dynamic(
  () => import('@/components/charts/word-cloud'),
  { ssr: false, loading: () => <LoadingSkeleton variant="chart" /> }
)
```

### WordCloudChart Props

```typescript
interface WordCloudChartProps {
  words: Array<{ word: string; count: number }>
}
```

Internally, map `count` to the `value` property expected by `react-d3-cloud`:
```typescript
const cloudWords = words.map(w => ({ text: w.word, value: w.count }))
```

### Font Size Scaling

`react-d3-cloud` accepts `fontSize` as a function:
```typescript
fontSize={(word) => Math.log2(word.value) * 8 + 10}
```

This produces sizes from ~18px (count=1) up to ~80px (count=500+), which scales well for the expected data range.

### Color Palette (AC10)

Use a fixed palette array distinct from blue/rose candidate colors:
```typescript
const WORD_COLORS = [
  '#f97316', // orange-500
  '#14b8a6', // teal-500
  '#a855f7', // purple-500
  '#eab308', // yellow-500
  '#06b6d4', // cyan-500
  '#84cc16', // lime-500
  '#ec4899', // pink-500 (different hue from rose)
  '#8b5cf6', // violet-500
]

const fill = (_word: string, index: number) => WORD_COLORS[index % WORD_COLORS.length]
```

### Tooltip (AC5)

`react-d3-cloud` supports an `onWordClick` callback. For hover tooltip, use a state variable:

```typescript
const [tooltip, setTooltip] = useState<{ word: string; count: number; x: number; y: number } | null>(null)

// In the WordCloud component:
onWordMouseOver={(event, word) => {
  setTooltip({ word: word.text, count: word.value, x: event.clientX, y: event.clientY })
}}
onWordMouseOut={() => setTooltip(null)}
```

Render a fixed-position tooltip div when `tooltip` is set.

### Subtitle (AC6)

```typescript
const filterLabel = candidateFilter === 'all'
  ? 'Todos os candidatos'
  : candidateFilter === 'charlles'
    ? 'Charlles Evangelista'
    : 'Delegada Sheila'
```

Render as `<p className="text-sm text-muted-foreground">{filterLabel} — {data.total_unique_words} palavras unicas</p>`.

### Candidate UUID Resolution

Same pattern as Story 2.4 — resolve username to UUID for the API call. Use the `useOverview` data or a separate candidate map in constants.

[AUTO-DECISION] Create a helper `getCandidateId(filter, overviewData)` in `src/lib/utils.ts` that resolves the URL param value to a UUID. This helper can be reused across pages 2.4, 2.5, 2.6 that all need to resolve candidate IDs.

---

## Tasks / Subtasks

- [x] T1: Install word cloud library (AC1)
  - [x] T1.1: `pnpm add react-d3-cloud`
  - [x] T1.2: Verify the library renders in a test component without errors

- [x] T2: Create WordCloudChart component (AC1, AC2, AC5, AC10)
  - [x] T2.1: Create `src/components/charts/word-cloud.tsx` as a Client Component
  - [x] T2.2: Map API word data to library format
  - [x] T2.3: Configure font size scaling function (log2 based)
  - [x] T2.4: Apply custom color palette (orange, teal, purple, yellow, cyan, lime, pink, violet)
  - [x] T2.5: Implement hover tooltip with word + count

- [x] T3: Build words page (AC3, AC4, AC6, AC7, AC8, AC9)
  - [x] T3.1: Convert `/words` placeholder to page with dynamic import (SSR disabled)
  - [x] T3.2: Wire `useWordCloud` hook with `candidateId` param
  - [x] T3.3: Add subtitle showing current filter and unique word count
  - [x] T3.4: Implement loading state (skeleton)
  - [x] T3.5: Implement empty state

- [x] T4: CandidateFilter integration (AC3, AC4)
  - [x] T4.1: Read `candidate` URL param and resolve to UUID via getCandidateId utility
  - [x] T4.2: Re-fetch when candidate param changes (hook deps auto-trigger)

---

## Dev Notes

### Testing
- No automated tests required for this story
- Manual testing checklist:
  - Word cloud renders with visible words at proportional sizes
  - Color palette is visually distinct (not blue/rose)
  - Hover tooltip shows word and count
  - CandidateFilter switches between all/charlles/sheila data
  - SSR is disabled (no hydration mismatch in browser console)
  - Loading skeleton appears before data loads
  - Empty state shown when no words returned

### Notes from Architecture
- The API applies Portuguese stop word filtering server-side (NFR-003). No client-side filtering is needed.
- The `react-d3-cloud` library renders to SVG. The containing div needs explicit `height` and `width` to prevent a zero-size canvas. Recommend: `width={800}` and `height={400}` as default props, with a responsive wrapper that uses `ResizeObserver` or just a fixed size for MVP.
- [AUTO-DECISION] For MVP, use a fixed size `width={800} height={400}` on the WordCloud component. If the window is narrower, the SVG will be clipped but this is acceptable given "desktop primary" UX requirement (PRD section 11.6).
- Dynamic imports (`next/dynamic`) are essential here. Word cloud libraries use browser-only APIs (canvas, getBoundingClientRect) that crash during SSR.

---

## Risks

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| `react-d3-cloud` may have compatibility issues with Next.js 16 or React 19 | Medium | High | AUTO-DECISION documents `@visx/wordcloud` as fallback. Test library installation and basic render before building full component |
| Word cloud library uses browser-only APIs (canvas, getBoundingClientRect) causing SSR crashes | High | High | AC9 mandates `next/dynamic` with `{ ssr: false }`. This is already addressed in the story |
| Fixed `width={800} height={400}` clips on narrow viewports | Medium | Low | Acceptable for MVP per PRD 11.6 "desktop primary". Document as known limitation for post-MVP improvement |
| Large word lists (500+ words) may cause slow rendering in SVG | Low | Medium | API returns frequency-sorted words; limit to top 100 words client-side if performance issues arise |
| Library choice (`react-d3-cloud`) deviates from PRD/architecture suggestions (`react-wordcloud`, `@visx/wordcloud`) | Low | Low | PRD/architecture use "e.g." language, not mandates. AUTO-DECISION provides valid technical justification (peer dep conflicts) |

---

## Validation

| Date | Validator | Score | Verdict | Notes |
|------|-----------|-------|---------|-------|
| 2026-02-21 | Pax (PO) | 9/10 | GO | Missing Risks section was only failure; added during validation. API contract verified against architecture.md section 3.2.4. Library choice deviation from PRD suggestions is justified by AUTO-DECISION with valid fallback |

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `src/components/charts/word-cloud.tsx` | Created | Word cloud visualization using react-d3-cloud with hover tooltip and color palette |
| `src/app/words/page.tsx` | Modified | Server Component wrapper with Suspense boundary |
| `src/app/words/words-content.tsx` | Created | Client Component with dynamic import, useWordCloud integration, filter subtitle |
| `package.json` | Modified | Added react-d3-cloud dependency |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story created | River (SM Agent) |
| 2026-02-21 | 1.1 | Validated: GO 9/10. Added Risks and Validation sections. Status Draft -> Ready | Pax (PO Agent) |
| 2026-02-21 | 1.2 | Implementation complete. All ACs met. Build passes. Status Ready -> InProgress | Dex (Dev Agent) |
