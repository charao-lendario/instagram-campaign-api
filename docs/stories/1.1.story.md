# Story 1.1: Setup FastAPI + Supabase Client + Estrutura de Projeto

## Status: InProgress
## Epic: 1 - Backend (FastAPI + Apify)
## Points: 3

---

## Description

Como desenvolvedor backend, quero configurar a base completa do projeto FastAPI com o cliente Supabase, variáveis de ambiente via pydantic-settings, logging estruturado, e todos os modelos Pydantic para as 6 tabelas do schema, de forma que todas as stories subsequentes tenham uma fundação confiável e consistente para construir.

O scaffolding inicial já existe (`app/main.py`, `app/models/`, `app/routers/`, `app/services/`, `app/db/`). Esta story completa o que falta: configuração de settings, cliente Supabase singleton, modelos completos, logging estruturado, e verificação de saúde básica.

---

## Acceptance Criteria

- [x] **AC1**: Given que as variáveis de ambiente `SUPABASE_URL` e `SUPABASE_KEY` estão definidas, when a aplicação inicia, then `app/core/config.py` carrega todas as settings via `pydantic-settings` sem erro, e um `settings` singleton está disponível globalmente.
  - Settings obrigatórias: `SUPABASE_URL`, `SUPABASE_KEY`, `APIFY_TOKEN`, `LLM_PROVIDER` (default: openai), `LLM_MODEL` (default: gpt-4o-mini), `LLM_API_KEY`, `ALLOWED_ORIGINS` (default: *), `SCRAPING_INTERVAL_HOURS` (default: 6), `LOG_LEVEL` (default: INFO).

- [x] **AC2**: Given que o módulo `app/db/supabase.py` é importado, when `get_supabase()` é chamado múltiplas vezes, then retorna sempre a mesma instância do cliente Supabase (padrão singleton), utilizando `settings.SUPABASE_URL` e `settings.SUPABASE_KEY`.

- [x] **AC3**: Given que a aplicação está rodando, when `GET /health` é chamado, then retorna `200 OK` com payload `{"status": "ok", "database": "connected" | "disconnected", "scheduler": "stopped", "last_scrape": null}`. O campo `database` reflete conectividade real com Supabase (tenta uma query simples na tabela `candidates`).

- [x] **AC4**: Given que os modelos Pydantic são definidos, when usados em endpoints FastAPI, then os seguintes modelos existem em `app/models/` e cobrem todas as colunas do SCHEMA.md:
  - `candidate.py`: `Candidate`, `CandidateCreate`
  - `post.py`: `Post`, `PostCreate`, `PostUpsert`
  - `comment.py`: `Comment`, `CommentCreate`, `CommentUpsert`
  - `sentiment.py`: `SentimentScore`, `SentimentResult`, `LLMSentimentResult`
  - `theme.py`: `Theme`, `ThemeCreate`
  - `scraping.py`: `ScrapingRun`, `ScrapingRunCreate`, `ScrapingRunUpdate`
  - `analytics.py`: `OverviewMetrics`, `SentimentTimelinePoint`, `WordEntry`, `ThemeDistribution`, `PostRanking`, `CandidateComparison`
  - `suggestion.py`: `StrategicSuggestion`, `SuggestionsResponse`

- [x] **AC5**: Given que o logging está configurado, when qualquer módulo usa `logging.getLogger(__name__)`, then as mensagens saem em formato estruturado (JSON ou texto com nível + timestamp + nome do módulo), com nível controlado por `settings.LOG_LEVEL`.

- [x] **AC6**: Given que `app/core/constants.py` existe, when importado, then contém: lista de stop words em português (mínimo 50 palavras), dicionário de keywords por tema (`THEME_KEYWORDS` com as 9 categorias definidas no SCHEMA.md: saude, seguranca, educacao, economia, infraestrutura, corrupcao, emprego, meio_ambiente, outros), e as constantes de threshold do VADER (`VADER_POSITIVE_THRESHOLD = 0.05`, `VADER_NEGATIVE_THRESHOLD = -0.05`, `LLM_CONFIDENCE_THRESHOLD = 0.7`, `LLM_AMBIGUOUS_MIN_LENGTH = 20`).

- [x] **AC7**: Given que as migrations do Supabase existem em `supabase/migrations/` (001-005), when executadas em ordem no Supabase, then as 6 tabelas são criadas (`candidates`, `posts`, `comments`, `sentiment_scores`, `themes`, `scraping_runs`) com os tipos enum corretos, indexes e seed data dos 2 candidatos. As migrations já existem no repositório -- esta AC valida que estão completas e corretas conforme o SCHEMA.md.

- [x] **AC8**: Given que o CORS está configurado em `app/main.py`, when `ALLOWED_ORIGINS` é `"*"` (dev), then todas as origens são aceitas; quando é uma URL específica (prod), then apenas aquela origem é aceita. Os métodos permitidos são `GET` e `POST`.

- [x] **AC9**: Given que os unit tests existem em `tests/`, when `pytest tests/test_config.py` é executado, then verifica: carregamento de settings com valores mockados, inicialização do cliente Supabase, e resposta do endpoint `/health` com Supabase mockado.

---

## Scope

### IN
- `app/core/config.py` com pydantic-settings
- `app/core/constants.py` com stop words, theme keywords e thresholds
- `app/core/logging.py` com structured logging setup
- `app/db/supabase.py` com singleton do cliente
- Todos os modelos Pydantic em `app/models/` (8 arquivos)
- Endpoint `GET /health` em `app/routers/health.py`
- Atualização de `app/main.py` com CORS, lifespan, router registration
- `tests/conftest.py` com fixtures compartilhadas (mock Supabase, mock Apify)
- `tests/test_config.py` com unit tests de configuração
- Arquivo `.env.example` com todas as variáveis documentadas

### OUT
- Implementação dos serviços de scraping (Story 1.2)
- Lógica do scheduler (Story 1.7)
- Endpoints de analytics (Story 1.6)
- Qualquer lógica de negócio além de health check

---

## Dependencies

- Supabase project criado e acessível (pré-requisito externo)
- `requirements.txt` existente no repositório com dependências do projeto
- Migrations `supabase/migrations/001-005` já presentes no repositório

---

## Risks

| Risco | Probabilidade | Impacto | Mitigacao |
|-------|---------------|---------|-----------|
| Incompatibilidade de versao do supabase-py com custom enum types do schema | Baixa | Media | Verificar versao no requirements.txt antes de escrever modelos; testar upsert com enums |
| Coluna `profile_url` GENERATED STORED requer tratamento especial no Pydantic (campo read-only) | Baixa | Baixa | Ja documentado em Dev Notes; usar `Optional` e excluir de Create models |
| Divergencia entre SCHEMA.md (7 tabelas, colunas extras) e modelos simplificados da story | Media | Baixa | AC4 diz "cobrem todas as colunas do SCHEMA.md" -- dev deve seguir SCHEMA.md como fonte de verdade para colunas |
| Tabela `strategic_insights` do SCHEMA.md nao tem modelo explicito em AC4 | Baixa | Baixa | `suggestion.py` cobre os response models; table-level model pode ser adicionado em Story 1.7 |

---

## Technical Notes

### Arquitetura Relevante (architecture.md Seção 2.1)

Estrutura de pastas esperada:
```
app/
  main.py          # FastAPI app, CORS, lifespan
  core/
    config.py      # pydantic-settings
    constants.py   # stop words, theme keywords, thresholds
    logging.py     # structured logging
  db/
    supabase.py    # client singleton
  models/
    candidate.py
    post.py
    comment.py
    sentiment.py
    theme.py
    scraping.py
    analytics.py
    suggestion.py
  routers/
    health.py
```

### Endpoint Envolvido
- `GET /health` -- retorna service status, database status, scheduler status, last_scrape

### Tabelas Envolvidas (SCHEMA.md)
- `candidates` (read em health check)
- Todos os modelos mapeiam para as 6 tabelas do schema + strategic_insights

### Tipos Enum do SCHEMA.md (custom PostgreSQL types)
- `sentiment_label`: positive | negative | neutral
- `scraping_status`: running | success | failed | partial
- `theme_category`: saude | seguranca | educacao | economia | infraestrutura | corrupcao | emprego | meio_ambiente | outros
- `analysis_method`: keyword | llm
- `media_type`: image | video | carousel | unknown

### Padrão Singleton do Cliente (architecture.md Seção 6.2)
```python
# app/db/supabase.py
from supabase import create_client, Client
from app.core.config import settings

_client: Client | None = None

def get_supabase() -> Client:
    global _client
    if _client is None:
        _client = create_client(settings.SUPABASE_URL, settings.SUPABASE_KEY)
    return _client
```

### Resposta de /health (architecture.md Seção 3.2.1)
```json
{
  "status": "ok",
  "database": "connected",
  "scheduler": "stopped",
  "last_scrape": null
}
```

### PRD References
- FR-005: Data Persistence (Supabase setup)
- FR-015: API Health Check
- CON-003: Tech Stack -- pydantic-settings, supabase-py
- CON-005: Database -- Supabase PostgreSQL
- NFR-006: Security -- env vars para todos os secrets
- NFR-008: Observability -- structured logging
- NFR-010: Code Quality -- type hints, Pydantic, PEP 8

---

## File List

| Arquivo | Acao | Status |
|---------|------|--------|
| `app/main.py` | Modificar -- CORS, lifespan, router registration | Feito |
| `app/core/__init__.py` | Criar | Feito |
| `app/core/config.py` | Criar | Feito |
| `app/core/constants.py` | Criar | Feito |
| `app/core/logging.py` | Criar | Feito |
| `app/db/supabase.py` | Criar | Feito |
| `app/models/enums.py` | Criar (tipos enum compartilhados) | Feito |
| `app/models/candidate.py` | Criar | Feito |
| `app/models/post.py` | Criar | Feito |
| `app/models/comment.py` | Criar | Feito |
| `app/models/sentiment.py` | Criar | Feito |
| `app/models/theme.py` | Criar | Feito |
| `app/models/scraping.py` | Criar | Feito |
| `app/models/analytics.py` | Criar | Feito |
| `app/models/suggestion.py` | Criar | Feito |
| `app/routers/health.py` | Criar | Feito |
| `tests/__init__.py` | Criar | Feito |
| `tests/conftest.py` | Criar | Feito |
| `tests/test_config.py` | Criar | Feito |
| `.env.example` | Atualizar -- todas as variáveis documentadas | Feito |

---

## Dev Notes

- **supabase-py v2.10.0** confirmado em requirements.txt -- compativel com o schema.
- **profile_url** (GENERATED STORED): marcado como `Optional[str]` no modelo `Candidate`, excluido de `CandidateCreate`.
- **updated_at** (trigger): presente nos modelos de leitura (`Candidate`, `Post`, `SentimentScore`), excluido dos modelos Create/Upsert.
- **enums.py** criado como modulo compartilhado para evitar duplicacao dos 5 enum types entre modelos.
- **suggestion.py** inclui tanto os response models (AC4) quanto `StrategicInsight`/`StrategicInsightCreate` mapeando a tabela `strategic_insights` do SCHEMA.md.
- **SentimentScoreCreate** adicionado (nao listado no AC4 mas necessario para o service de sentiment analysis).
- **STOP_WORDS_PT**: 101 palavras (acima do minimo de 50).
- **CORS**: `allow_methods` restrito a `["GET", "POST"]` conforme AC8 (anteriormente era `["*"]`).

---

## Validation

**Validator:** Pax (PO Agent)
**Date:** 2026-02-21
**Verdict:** GO (9/10)

| # | Criterio | Resultado |
|---|----------|-----------|
| 1 | Titulo claro e objetivo | PASS |
| 2 | Descricao completa (problema/necessidade) | PASS |
| 3 | AC testaveis (Given/When/Then) | PASS |
| 4 | Escopo bem definido (IN/OUT) | PASS |
| 5 | Dependencias mapeadas | PASS |
| 6 | Estimativa de complexidade | PASS |
| 7 | Valor de negocio claro | PASS |
| 8 | Riscos documentados | FAIL (adicionado durante validacao) |
| 9 | Criterios de Done | PASS |
| 10 | Alinhamento com PRD/Epic | PASS |

**Observacoes:**

1. **Riscos (corrigido):** Story nao tinha secao de Risks. Adicionada durante validacao com 4 riscos identificados.
2. **Divergencia de schema:** O SCHEMA.md define colunas adicionais (profile_url, is_active, shortcode, is_sponsored, video_view_count, raw_data, reply_count, scraping_run_id, vader_positive/negative/neutral, llm_model, duration_seconds, metadata) que nao estao listadas nos modelos do AC4. O AC4 diz "cobrem todas as colunas do SCHEMA.md" -- o dev DEVE usar o SCHEMA.md como fonte de verdade para as colunas de cada modelo.
3. **strategic_insights:** Tabela presente no SCHEMA.md mas sem modelo explicito no AC4. O `suggestion.py` cobre response models; modelo de tabela pode ser adicionado quando necessario (Story 1.7).
4. **Titulo diverge do Epic:** Epic diz "Database Schema & Supabase Setup", story diz "Setup FastAPI + Supabase Client + Estrutura de Projeto". Story file e a fonte de verdade -- o escopo mais amplo e correto.

**Status transition:** Draft -> Ready

---

## Change Log

| Data | Autor | Descricao |
|------|-------|-----------|
| 2026-02-21 | River (SM) | Story criada |
| 2026-02-21 | Pax (PO) | Validacao: GO 9/10. Status Draft -> Ready. Adicionada secao Risks. |
| 2026-02-21 | Dex (Dev) | Implementacao completa: AC1-AC9 todos atendidos. Status Ready -> InProgress. 20 arquivos criados/modificados. 7 testes passando. |
