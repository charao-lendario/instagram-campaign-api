# Story 2.7: Post Comparison & Candidate Comparison

## Status: Draft

## Epic: EPIC-2 - Frontend Dashboard
## Story Points: 8

---

## Story

**As a** campaign strategist,
**I want** a ranked list of posts sorted by engagement metrics and a dedicated side-by-side candidate comparison view,
**so that** I can identify which content generates the best reactions and compare the two candidates head-to-head on all key metrics.

**PRD References**: FR-010, FR-011

---

## Acceptance Criteria

- [ ] AC1: Given the `/posts` page loads with data, when `usePosts()` returns post data, then a shadcn `Table` renders with columns: Candidato, Data, Legenda (caption), Curtidas, Comentarios, % Positivo, % Negativo, Sentimento Medio.
- [ ] AC2: Given the post table, when the page first loads, then rows are sorted by comment count descending (default sort per FR-010).
- [ ] AC3: Given the column headers, when a user clicks any column header, then the sort order toggles between ascending and descending for that column, and the active sort column is visually indicated (arrow icon up/down).
- [ ] AC4: Given the sort state changes, when a column is sorted, then `usePosts()` is called with the updated `sort_by` and `order` parameters, fetching sorted data from the API.
- [ ] AC5: Given the `CandidateFilter` in the header, when a single candidate is selected, then the table shows only that candidate's posts (`candidate_id` param sent to the API).
- [ ] AC6: Given the post table, when there are more than 20 rows, then a "Carregar mais" button appears below the table. When clicked, the next 20 posts are appended to the table (using the `offset` parameter).
- [ ] AC7: Given a post row, when the caption text exceeds 80 characters, then it is truncated with "..." and the full caption is shown in a `title` attribute (HTML tooltip) on hover.
- [ ] AC8: Given the `/comparison` page loads, when `useComparison()` returns data, then a 2-column layout renders side by side with one column per candidate, each showing: display name, total posts, total comments, average sentiment score (with SentimentBadge), total engagement, sentiment distribution bars (from Story 2.3 components), and top 3 themes.
- [ ] AC9: Given the comparison page, when rendered, then a trend direction indicator shows for each candidate: an upward green arrow with "Melhorando" when `trend.direction === "improving"`, a downward red arrow with "Declinando" when `"declining"`, and a horizontal gray dash with "Estavel" when `"stable"`.
- [ ] AC10: Given the comparison page, when rendered, then a mini sparkline Recharts `LineChart` without axes or labels shows the last visible data points per candidate (from `trend.recent_avg` and `trend.previous_avg` as 2 data points, or use the timeline endpoint for the last 10 posts if feasible within this story scope).
- [ ] AC11: Given data is loading on either page, when hooks return `loading: true`, then skeleton placeholders render for the table rows (posts page) or comparison cards (comparison page).
- [ ] AC12: Given an API error on either page, when hooks return `error`, then the shared `ErrorMessage` component renders with a retry button.

---

## Scope

### IN
- `/posts` page (`src/app/posts/page.tsx`) — sortable post table
- `/comparison` page (`src/app/comparison/page.tsx`) — side-by-side candidate view
- `Sparkline` component (`src/components/charts/sparkline.tsx`) — mini chart
- `TrendIndicator` component (`src/components/dashboard/trend-indicator.tsx`)
- Reuse of `MetricCard`, `SentimentBadge`, `SentimentBar` from Story 2.3
- Integration of `usePosts` and `useComparison` hooks (from Story 2.2)
- Client-side sort state management + API re-fetch on sort change
- "Load more" pagination for posts table (offset-based)

### OUT
- Full-page pagination (replace instead of append) — "Load more" append is the MVP approach
- Click-through from a post row to view its comments
- Comparison between more than 2 candidates
- Editable columns or column picker
- Export to CSV

---

## Dependencies

- Story 2.1 complete (layout, CandidateFilter, shadcn Table component)
- Story 2.2 complete (`usePosts`, `useComparison`, `PostData`, `ComparisonData` types, shared components)
- Story 2.3 complete (`MetricCard`, `SentimentBadge`, `SentimentBar` components for reuse in comparison)
- Recharts already installed (Stories 2.4/2.6)

---

## Technical Notes

### API Endpoints

**Posts:**
`GET /api/v1/analytics/posts`
Query params: `candidate_id?`, `sort_by?` (default: `comment_count`), `order?` (default: `desc`), `limit?` (default: 20), `offset?` (default: 0)

Valid `sort_by` values: `comment_count`, `like_count`, `positive_ratio`, `negative_ratio`, `sentiment_score`

Response (from architecture.md section 3.2.4):
```json
{
  "posts": [
    {
      "post_id": "uuid",
      "candidate_username": "charlles.evangelista",
      "url": "https://instagram.com/p/abc123",
      "caption": "Hoje visitamos o bairro...",
      "posted_at": "2026-02-15T10:30:00Z",
      "like_count": 234,
      "comment_count": 87,
      "positive_ratio": 0.48,
      "negative_ratio": 0.22,
      "average_sentiment_score": 0.19
    }
  ],
  "total": 20,
  "limit": 20,
  "offset": 0
}
```

**Comparison:**
`GET /api/v1/analytics/comparison` — no params.

Response (from architecture.md section 3.2.4):
```json
{
  "candidates": [
    {
      "candidate_id": "uuid",
      "username": "charlles.evangelista",
      "display_name": "Charlles Evangelista",
      "total_posts": 10,
      "total_comments": 487,
      "average_sentiment_score": 0.15,
      "total_engagement": 3542,
      "sentiment_distribution": { "positive": 210, "negative": 127, "neutral": 150 },
      "top_themes": [
        { "theme": "saude", "count": 52 },
        { "theme": "educacao", "count": 38 },
        { "theme": "seguranca", "count": 28 }
      ],
      "trend": {
        "direction": "improving",
        "recent_avg": 0.21,
        "previous_avg": 0.09,
        "delta": 0.12
      }
    }
  ]
}
```

### Post Table Column Mapping

| Column Label | Data Field | Sort Key |
|-------------|-----------|----------|
| Candidato | `candidate_username` | — (not sortable) |
| Data | `posted_at` (DD/MM/YY) | — |
| Legenda | `caption` (truncated 80 chars) | — |
| Curtidas | `like_count` | `like_count` |
| Comentarios | `comment_count` | `comment_count` |
| % Positivo | `positive_ratio * 100` formatted as "48%" | `positive_ratio` |
| % Negativo | `negative_ratio * 100` formatted as "22%" | `negative_ratio` |
| Sentimento | `average_sentiment_score` (2dp) with SentimentBadge color | `sentiment_score` |

### Sort State Management

```typescript
interface SortState {
  column: 'comment_count' | 'like_count' | 'positive_ratio' | 'negative_ratio' | 'sentiment_score'
  order: 'asc' | 'desc'
}

const [sort, setSort] = useState<SortState>({ column: 'comment_count', order: 'desc' })

const handleSort = (column: SortState['column']) => {
  setSort(prev =>
    prev.column === column
      ? { column, order: prev.order === 'desc' ? 'asc' : 'desc' }
      : { column, order: 'desc' }  // new column always starts descending
  )
}
```

The `usePosts` hook must accept `sortBy` and `order` parameters and re-fetch when they change.

### Load More Pagination

```typescript
const [offset, setOffset] = useState(0)
const [allPosts, setAllPosts] = useState<PostData[]>([])

// When new data arrives, append to allPosts (not replace)
useEffect(() => {
  if (data?.posts) {
    if (offset === 0) setAllPosts(data.posts)           // reset on filter/sort change
    else setAllPosts(prev => [...prev, ...data.posts])  // append on load more
  }
}, [data])

const handleLoadMore = () => setOffset(prev => prev + 20)
const showLoadMore = allPosts.length < (data?.total ?? 0)
```

Reset `offset` to 0 when sort or candidate filter changes.

### TrendIndicator Component

```typescript
// src/components/dashboard/trend-indicator.tsx
interface TrendIndicatorProps {
  direction: 'improving' | 'declining' | 'stable'
  delta: number
}
```

Render:
- `improving`: `↑ Melhorando` in `text-green-600`
- `declining`: `↓ Declinando` in `text-red-600`
- `stable`: `→ Estavel` in `text-slate-500`

Use Unicode arrows or Lucide icons (`ArrowUp`, `ArrowDown`, `Minus` from `lucide-react`). Install if not already: `pnpm add lucide-react`.

### Sparkline Component (AC10)

[AUTO-DECISION] For MVP, the sparkline shows only 2 data points: `previous_avg` and `recent_avg` from the trend object. This is sufficient to show improvement/decline direction without a separate timeline API call.

```typescript
// src/components/charts/sparkline.tsx
'use client'
import { LineChart, Line, ResponsiveContainer } from 'recharts'

interface SparklineProps {
  previousAvg: number
  recentAvg: number
  color: string
}

const data = [
  { value: props.previousAvg },
  { value: props.recentAvg }
]
```

Render a minimal chart (no axes, no tooltip, no grid, no legend):
```tsx
<ResponsiveContainer width="100%" height={60}>
  <LineChart data={data}>
    <Line type="monotone" dataKey="value" stroke={color} strokeWidth={2} dot={false} />
  </LineChart>
</ResponsiveContainer>
```

### Comparison Page Layout

```
src/app/comparison/page.tsx (Client Component)
  <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
    {candidates.map(candidate => (
      <CandidateComparisonCard candidate={candidate} />
    ))}
  </div>
```

`CandidateComparisonCard` (inline component or extract to `dashboard/candidate-comparison-card.tsx`):
- Uses shadcn Card
- Renders: display name, sentiment badge, metric counts, SentimentBar (from Story 2.3), top 3 themes (as Badge list), TrendIndicator, Sparkline

### Theme Formatting in Comparison

Reuse `formatThemeLabel` from Story 2.6 (already in `src/lib/utils.ts`).

---

## Tasks / Subtasks

- [ ] T1: Create TrendIndicator component (AC9)
  - [ ] T1.1: `pnpm add lucide-react` (if not installed)
  - [ ] T1.2: Create `src/components/dashboard/trend-indicator.tsx`

- [ ] T2: Create Sparkline component (AC10)
  - [ ] T2.1: Create `src/components/charts/sparkline.tsx` using 2-point Recharts LineChart
  - [ ] T2.2: Verify rendering with minimal configuration (no axes/grid)

- [ ] T3: Build posts page with sortable table (AC1, AC2, AC3, AC4, AC5, AC6, AC7)
  - [ ] T3.1: Convert `/posts` placeholder to Client Component
  - [ ] T3.2: Implement sort state and column header click handlers
  - [ ] T3.3: Wire `usePosts` hook with sort and candidate params
  - [ ] T3.4: Build shadcn Table with all 8 columns
  - [ ] T3.5: Implement caption truncation (80 chars + title attribute)
  - [ ] T3.6: Implement "Carregar mais" button with offset pagination
  - [ ] T3.7: Implement loading (table row skeletons) and error states

- [ ] T4: Build comparison page (AC8, AC9, AC10, AC11, AC12)
  - [ ] T4.1: Convert `/comparison` placeholder to Client Component
  - [ ] T4.2: Wire `useComparison` hook
  - [ ] T4.3: Build 2-column candidate card layout
  - [ ] T4.4: Integrate reused components: SentimentBadge, SentimentBar (from Story 2.3)
  - [ ] T4.5: Add TrendIndicator and Sparkline to each card
  - [ ] T4.6: Display top 3 themes with formatted labels and count badges
  - [ ] T4.7: Implement loading (card skeletons) and error states

---

## Dev Notes

### Testing
- No automated tests required for this story
- Manual testing checklist:
  - Posts table renders all 8 columns
  - Default sort is by comment_count descending
  - Clicking column header sorts ascending/descending with arrow indicator
  - Sorting triggers new API call (visible in Network tab)
  - CandidateFilter shows/hides candidate rows
  - "Carregar mais" appends rows without replacing existing ones
  - Long captions are truncated and full text appears in browser hover
  - Comparison page shows both candidates side by side
  - Trend indicators show correct direction with correct colors
  - Sparkline mini chart shows improvement/decline visually

### Notes from Architecture
- The `usePosts` hook from Story 2.2 must accept `sortBy`, `order`, and `offset` as parameters. When creating Story 2.2, these were declared in the hook signature. Verify the hook signature accepts all needed params.
- The `PostData.positive_ratio` and `negative_ratio` from the API are already floats between 0 and 1 (e.g., 0.48 means 48%). Format as percentage strings for display: `(ratio * 100).toFixed(0) + '%'`.
- `PostData.average_sentiment_score` should be displayed with 2 decimal places and colored using the same `getSentimentVariant` thresholds from Story 2.3 (>= 0.05 = green, <= -0.05 = red).
- The `ComparisonData.candidates` array from the API always has exactly 2 entries (both monitored candidates). No edge case handling needed for 0 or 1 candidates in this view.
- `formatThemeLabel` from Story 2.6 should already be in `src/lib/utils.ts`. Import and reuse it here.
- Lucide React is compatible with Next.js App Router. Use named imports: `import { ArrowUp, ArrowDown, Minus } from 'lucide-react'`.

---

## File List

_To be populated by dev agent during implementation._

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story created | River (SM Agent) |
