# Story 2.6: Theme Analysis View

## Status: Draft

## Epic: EPIC-2 - Frontend Dashboard
## Story Points: 5

---

## Story

**As a** campaign strategist,
**I want** to see how Instagram comments are distributed across political themes (health, security, education, economy, etc.) for each candidate,
**so that** I can identify which topics dominate public discourse and where to focus or adjust campaign messaging.

**PRD References**: FR-009

---

## Acceptance Criteria

- [ ] AC1: Given the `/themes` page loads with data, when `useThemes()` returns theme data, then a grouped Recharts `BarChart` renders with: themes on the X-axis (sorted by total count descending), comment count on the Y-axis, and one `Bar` per candidate using the candidate color variables.
- [ ] AC2: Given the grouped bar chart, when rendered with both candidates visible, then each theme group shows two bars side by side — one for charlles.evangelista (blue) and one for delegadasheila (rose) — with a `Legend` identifying each candidate.
- [ ] AC3: Given a toggle button labeled "Ver como pizza" / "Ver como barras", when the user clicks it, then the view switches between the grouped `BarChart` and a side-by-side `PieChart` layout showing one pie per candidate with theme proportions.
- [ ] AC4: Given the `CandidateFilter` selects a single candidate, when viewing bar mode, then only one bar series is shown per theme (no grouped bars). When viewing pie mode, only one pie chart renders.
- [ ] AC5: Given the bar chart, when rendered, then each bar displays its value (count) as a `label` on top of or inside the bar using Recharts `LabelList`.
- [ ] AC6: Given the pie chart view, when a slice is rendered, then each slice shows its theme name and percentage inside or as a Recharts `label` / `labelLine`.
- [ ] AC7: Given theme names from the API (lowercase Portuguese: `saude`, `seguranca`, `educacao`, `economia`, `infraestrutura`, `corrupcao`, `emprego`, `meio_ambiente`, `outros`), when displayed in the UI, then they are capitalized and human-readable (e.g., "Saude" -> "Saude", "meio_ambiente" -> "Meio Ambiente", "outros" -> "Outros").
- [ ] AC8: Given data is loading, when `useThemes()` returns `loading: true`, then skeleton placeholders render in place of the charts.
- [ ] AC9: Given an error, when `useThemes()` returns `error`, then the shared `ErrorMessage` component renders with a retry button.
- [ ] AC10: Given an empty themes response, when `useThemes()` returns no themes, then the `EmptyState` component renders with "Nenhum tema identificado nos comentarios."

---

## Scope

### IN
- `/themes` page (`src/app/themes/page.tsx`)
- `ThemeBarChart` component (`src/components/charts/theme-bar.tsx`)
- `ThemePieChart` component (`src/components/charts/theme-pie.tsx`)
- Toggle button to switch between bar and pie views
- Theme label formatting utility
- CandidateFilter integration
- `useThemes` hook integration (from Story 2.2)

### OUT
- Click-through from theme to filtered comment list
- Theme management or configuration via UI
- Trend over time per theme (would require a different API endpoint)
- Export to CSV/PDF

---

## Dependencies

- Story 2.1 complete (layout, CandidateFilter, shadcn Button)
- Story 2.2 complete (`useThemes` hook, `ThemesResponse`/`ThemeData` types, shared components)
- Recharts already installed (Story 2.4)

---

## Technical Notes

### API Endpoint

`GET /api/v1/analytics/themes`

Query parameters:
- `candidate_id` (optional UUID): filter by candidate

Response shape (from architecture.md section 3.2.4):
```json
{
  "themes": [
    {
      "theme": "saude",
      "count": 87,
      "percentage": 17.2,
      "by_candidate": [
        { "candidate_id": "uuid", "username": "charlles.evangelista", "count": 52 },
        { "candidate_id": "uuid", "username": "delegadasheila", "count": 35 }
      ]
    },
    {
      "theme": "seguranca",
      "count": 65,
      "percentage": 12.8,
      "by_candidate": [
        { "candidate_id": "uuid", "username": "charlles.evangelista", "count": 28 },
        { "candidate_id": "uuid", "username": "delegadasheila", "count": 37 }
      ]
    }
  ]
}
```

### Theme Label Formatting (AC7)

```typescript
// src/lib/utils.ts
const THEME_LABELS: Record<string, string> = {
  saude: 'Saude',
  seguranca: 'Seguranca',
  educacao: 'Educacao',
  economia: 'Economia',
  infraestrutura: 'Infraestrutura',
  corrupcao: 'Corrupcao',
  emprego: 'Emprego',
  meio_ambiente: 'Meio Ambiente',
  outros: 'Outros',
}

export function formatThemeLabel(theme: string): string {
  return THEME_LABELS[theme] ?? theme.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())
}
```

### Data Transformation for BarChart

Recharts grouped `BarChart` requires data in the shape of one object per theme:
```typescript
interface BarChartDataPoint {
  theme: string              // formatted label
  charlles: number           // count for charlles.evangelista
  sheila: number             // count for delegadasheila
}

function toBarChartData(themes: ThemeData[], candidateFilter: string): BarChartDataPoint[] {
  return themes
    .sort((a, b) => b.count - a.count)
    .map(t => ({
      theme: formatThemeLabel(t.theme),
      charlles: t.by_candidate.find(c => c.username === 'charlles.evangelista')?.count ?? 0,
      sheila: t.by_candidate.find(c => c.username === 'delegadasheila')?.count ?? 0,
    }))
}
```

When `candidateFilter === 'charlles'`, render only one `<Bar dataKey="charlles" />`. When `'sheila'`, render only `<Bar dataKey="sheila" />`. When `'all'`, render both.

### ThemeBarChart Component

```typescript
// src/components/charts/theme-bar.tsx
'use client'
import {
  ResponsiveContainer, BarChart, Bar, XAxis, YAxis,
  CartesianGrid, Tooltip, Legend, LabelList
} from 'recharts'

interface ThemeBarChartProps {
  data: BarChartDataPoint[]
  candidateFilter: 'all' | 'charlles' | 'sheila'
}
```

Recharts config:
```tsx
<BarChart data={data} margin={{ top: 20, right: 30, left: 0, bottom: 5 }}>
  <CartesianGrid strokeDasharray="3 3" />
  <XAxis dataKey="theme" />
  <YAxis />
  <Tooltip />
  <Legend />
  {(candidateFilter === 'all' || candidateFilter === 'charlles') && (
    <Bar dataKey="charlles" name="Charlles Evangelista" fill={CANDIDATE_A_COLOR}>
      <LabelList dataKey="charlles" position="top" />
    </Bar>
  )}
  {(candidateFilter === 'all' || candidateFilter === 'sheila') && (
    <Bar dataKey="sheila" name="Delegada Sheila" fill={CANDIDATE_B_COLOR}>
      <LabelList dataKey="sheila" position="top" />
    </Bar>
  )}
</BarChart>
```

### ThemePieChart Component

```typescript
// src/components/charts/theme-pie.tsx
'use client'
import { PieChart, Pie, Cell, Tooltip, Legend } from 'recharts'
```

Data shape for pie:
```typescript
interface PieDataPoint { name: string; value: number }

function toPieData(themes: ThemeData[], candidateUsername: string): PieDataPoint[] {
  return themes.map(t => ({
    name: formatThemeLabel(t.theme),
    value: t.by_candidate.find(c => c.username === candidateUsername)?.count ?? 0
  })).filter(d => d.value > 0)
}
```

For "all" mode: render two `<PieChart>` side by side (one per candidate) in a 2-column grid. For single candidate: render one centered `<PieChart>`.

Pie color: use the 8-color `WORD_COLORS` palette from Story 2.5 (reuse from constants) or define a dedicated theme palette.

### Toggle Button (AC3)

```typescript
const [chartMode, setChartMode] = useState<'bar' | 'pie'>('bar')

<Button
  variant="outline"
  onClick={() => setChartMode(m => m === 'bar' ? 'pie' : 'bar')}
>
  {chartMode === 'bar' ? 'Ver como pizza' : 'Ver como barras'}
</Button>
```

### Page Structure

```
src/app/themes/page.tsx            (Client Component wrapper)
  - Toggle button (bar/pie)
  - CandidateFilter reading from URL params
  - useThemes hook
  - Conditional render: ThemeBarChart or ThemePieChart
  - Loading/error/empty states
```

---

## Tasks / Subtasks

- [ ] T1: Create theme label utility (AC7)
  - [ ] T1.1: Add `formatThemeLabel` function to `src/lib/utils.ts`
  - [ ] T1.2: Add `THEME_LABELS` map with all 9 theme_category values from schema

- [ ] T2: Create ThemeBarChart component (AC1, AC2, AC4, AC5)
  - [ ] T2.1: Create `src/components/charts/theme-bar.tsx`
  - [ ] T2.2: Implement data transformation from API format to Recharts grouped format
  - [ ] T2.3: Configure bars with candidate colors and LabelList on top
  - [ ] T2.4: Apply candidateFilter to show/hide bar series

- [ ] T3: Create ThemePieChart component (AC3, AC4, AC6)
  - [ ] T3.1: Create `src/components/charts/theme-pie.tsx`
  - [ ] T3.2: Implement per-candidate pie data transformation
  - [ ] T3.3: Handle dual-pie layout (two candidates) vs single-pie layout

- [ ] T4: Build themes page (AC3, AC8, AC9, AC10)
  - [ ] T4.1: Convert `/themes` placeholder to Client Component page
  - [ ] T4.2: Add bar/pie toggle button with state
  - [ ] T4.3: Wire `useThemes` hook
  - [ ] T4.4: Implement loading, error, empty states
  - [ ] T4.5: CandidateFilter integration from URL params

---

## Dev Notes

### Testing
- No automated tests required for this story
- Manual testing checklist:
  - Grouped bar chart renders with two bars per theme (when both candidates)
  - Bars use correct candidate colors (blue/rose)
  - Themes sorted by total count descending
  - Toggle between bar and pie works without errors
  - Pie charts show correct proportions
  - Theme labels are human-readable (no underscores, capitalized)
  - CandidateFilter switches single/both candidates correctly
  - Loading skeleton appears during fetch

### Notes from Architecture
- Theme categories from schema (SCHEMA.md section 2, `theme_category` enum): `saude`, `seguranca`, `educacao`, `economia`, `infraestrutura`, `corrupcao`, `emprego`, `meio_ambiente`, `outros`. The label map must cover all 9 values.
- The `percentage` field in the API response is the percentage of all comments (both candidates) for that theme. Do not use it directly for pie charts — use the per-candidate count divided by the candidate's total comments for candidate-specific pie slices.
- Recharts `LabelList` with `position="top"` works well for small counts. For small bars (count=1-2), the label may overlap — this is acceptable for MVP.
- The `PieChart` component in Recharts requires explicit `width` and `height` or `ResponsiveContainer`. For side-by-side pies, use flexbox layout with two `<div style={{ width: '50%', height: 300 }}>` containers.

---

## File List

_To be populated by dev agent during implementation._

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story created | River (SM Agent) |
