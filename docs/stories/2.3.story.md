# Story 2.3: Overview Dashboard

## Status: InProgress

## Epic: EPIC-2 - Frontend Dashboard
## Story Points: 5

---

## Story

**As a** campaign strategist,
**I want** an overview dashboard showing key engagement and sentiment metrics for both candidates side by side,
**so that** I can assess the current state of the campaign at a glance without drilling into individual charts.

**PRD References**: FR-006, FR-011

---

## Acceptance Criteria

- [x] AC1: Given the `/overview` page loads, when data is available from `GET /api/v1/analytics/overview`, then two metric cards are rendered side by side on desktop (>= 1024px) in a 2-column grid layout — one card per candidate.
- [x] AC2: Given each candidate metric card, when rendered, then it displays the following fields: candidate display name, username with @ prefix, total posts scraped, total comments, average sentiment score (as a number rounded to 2 decimals), sentiment distribution (positive/negative/neutral counts each with a percentage progress bar), and total engagement (sum of likes + comments).
- [x] AC3: Given the average sentiment score is displayed, when the value is >= 0.05, then it renders with a green `Badge` from shadcn/ui; when <= -0.05, it renders with a red `Badge`; otherwise a gray/neutral `Badge`.
- [x] AC4: Given a summary row at the top of the page (above the candidate cards), when rendered, then it shows: total comments analyzed (across both candidates), overall average sentiment score (average of both candidates), and last scraping run timestamp formatted as "DD/MM/YYYY HH:mm" in pt-BR locale (or "Nunca" if null).
- [x] AC5: Given the page is loading data, when `useOverview()` returns `loading: true`, then shadcn `Skeleton` components render in the shape of the metric cards (no blank white space, no layout shift).
- [x] AC6: Given an API error, when `useOverview()` returns `error`, then the shared `ErrorMessage` component renders with a "Tentar novamente" button that calls `refetch`.
- [x] AC7: Given no data exists yet (empty `candidates` array in response), when the page loads with an empty state, then the `EmptyState` component renders with the message "Nenhum dado disponivel. Inicie uma coleta de dados." and a "Iniciar coleta" button that triggers `POST /api/v1/scraping/run` via `triggerScraping()` from the API client.
- [x] AC8: Given the "Iniciar coleta" button is clicked, when `triggerScraping()` is called, then the button shows a loading spinner during the request and a success toast/alert appears on resolution.
- [x] AC9: Given the page on tablet viewport (768px-1023px), when rendered, then the two candidate cards stack vertically (1-column layout) and remain fully readable.
- [x] AC10: Given the `CandidateFilter` in the header (from Story 2.1), when a single candidate is selected, then only that candidate's card is shown (the other is hidden).

---

## Scope

### IN
- `/overview` page component (`src/app/overview/page.tsx`)
- `MetricCard` component (`src/components/dashboard/metric-card.tsx`)
- `SentimentBadge` component (`src/components/dashboard/sentiment-badge.tsx`)
- `SummaryRow` component (`src/components/dashboard/summary-row.tsx`)
- `SentimentBar` sub-component for positive/negative/neutral distribution bars
- Integration of `useOverview` hook and `triggerScraping` from Story 2.2
- Reading `candidate` URL search param from Story 2.1's `CandidateFilter`

### OUT
- Any chart components (Stories 2.4+)
- Comparison-specific trend direction (Story 2.7)
- Per-post drill-down (Story 2.7)

---

## Dependencies

- Story 2.1 complete (layout shell, CandidateFilter URL param, shadcn components)
- Story 2.2 complete (`useOverview`, `triggerScraping`, `ErrorMessage`, `LoadingSkeleton`, `EmptyState`, TypeScript types)

---

## Technical Notes

### API Endpoint

`GET /api/v1/analytics/overview` — no parameters.

Response shape (from architecture.md section 3.2.4):
```json
{
  "candidates": [
    {
      "candidate_id": "uuid",
      "username": "charlles.evangelista",
      "display_name": "Charlles Evangelista",
      "total_posts": 10,
      "total_comments": 487,
      "average_sentiment_score": 0.15,
      "sentiment_distribution": { "positive": 210, "negative": 127, "neutral": 150 },
      "total_engagement": 3542
    }
  ],
  "last_scrape": "2026-02-21T14:00:00Z",
  "total_comments_analyzed": 1010
}
```

### Component Structure

```
src/app/overview/page.tsx          (Client Component — uses useOverview hook)
  src/components/dashboard/
    summary-row.tsx                (total comments, avg sentiment, last scrape)
    metric-card.tsx                (per-candidate card using shadcn Card)
    sentiment-badge.tsx            (green/red/gray Badge based on score)
    sentiment-bar.tsx              (horizontal progress bar for pos/neg/neu %)
```

### MetricCard Props

```typescript
interface MetricCardProps {
  candidate: CandidateMetrics    // from src/lib/types.ts
  isHighlighted?: boolean        // optional: slight border emphasis
}
```

### SentimentBadge Logic

```typescript
function getSentimentVariant(score: number): 'positive' | 'negative' | 'neutral' {
  if (score >= 0.05) return 'positive'   // green Badge
  if (score <= -0.05) return 'negative'  // red/destructive Badge
  return 'neutral'                        // secondary/gray Badge
}
```

Use shadcn `Badge` with `variant` prop. Add a custom `positive` variant if not available by default (can extend via CSS class: `bg-green-100 text-green-800 border-green-200`).

### Sentiment Distribution Bars

Simple HTML progress bars or shadcn `Progress` component (install if needed: `pnpm dlx shadcn@latest add progress`):
- Positive: green (`bg-green-500`)
- Negative: red (`bg-red-500`)
- Neutral: gray (`bg-slate-400`)
- Width = `(count / total_comments) * 100%`

### CandidateFilter Integration

Read search params in the page:
```typescript
// src/app/overview/page.tsx
export default function OverviewPage({
  searchParams
}: {
  searchParams: { candidate?: string }
}) {
  // pass candidate filter to client component
}
```

Or use a Client Component wrapper that reads `useSearchParams()`.

### Scraping Trigger UX (AC8)

Use a simple inline state for the trigger button:
```typescript
const [triggering, setTriggering] = useState(false)
const [triggered, setTriggered] = useState(false)

const handleTrigger = async () => {
  setTriggering(true)
  try {
    await triggerScraping()
    setTriggered(true)
  } catch (e) {
    // show error
  } finally {
    setTriggering(false)
  }
}
```

No toast library required for MVP — a simple inline success message is sufficient.

### Date Formatting

Use `Intl.DateTimeFormat` for pt-BR formatting (no date-fns required for MVP):
```typescript
function formatDate(iso: string | null): string {
  if (!iso) return 'Nunca'
  return new Intl.DateTimeFormat('pt-BR', {
    day: '2-digit', month: '2-digit', year: 'numeric',
    hour: '2-digit', minute: '2-digit'
  }).format(new Date(iso))
}
```

---

## Tasks / Subtasks

- [x] T1: Create dashboard shared components (AC2, AC3)
  - [x] T1.1: Create `src/components/dashboard/sentiment-badge.tsx` with green/red/gray variants
  - [x] T1.2: Create `src/components/dashboard/sentiment-bar.tsx` for pos/neg/neu distribution
  - [x] T1.3: Create `src/components/dashboard/metric-card.tsx` using shadcn Card

- [x] T2: Create summary row component (AC4)
  - [x] T2.1: Create `src/components/dashboard/summary-row.tsx`
  - [x] T2.2: Implement `formatDate` utility in `src/lib/utils.ts` (or co-locate)

- [x] T3: Build overview page (AC1, AC5, AC6, AC7, AC8)
  - [x] T3.1: Convert `/overview` placeholder to actual page with `useOverview` integration
  - [x] T3.2: Implement loading state with Skeleton cards
  - [x] T3.3: Implement error state with ErrorMessage + retry
  - [x] T3.4: Implement empty state with "Iniciar coleta" button and trigger logic

- [x] T4: Implement CandidateFilter integration (AC10)
  - [x] T4.1: Read `candidate` search param and filter displayed cards accordingly

- [x] T5: Responsive layout (AC9)
  - [x] T5.1: Use Tailwind grid: `grid grid-cols-1 lg:grid-cols-2 gap-6`
  - [x] T5.2: Verify stacking behavior at 768px viewport

---

## Dev Notes

### Testing
- No automated tests required for this story (component tests are deferred per PRD 12.3 — component tests are for at least one chart view, covered in later stories)
- Manual testing checklist:
  - Data loads correctly from live/mocked API
  - Both candidate cards render with correct data
  - Sentiment badge colors match thresholds
  - Empty state trigger button fires scraping request
  - CandidateFilter hides/shows correct cards
  - Layout stacks at 768px

### Notes from Architecture
- The overview endpoint returns data for both candidates simultaneously — no per-candidate filtering at the API level. Filtering is done client-side via the CandidateFilter URL param.
- `total_engagement` from the API = likes + comments (already pre-computed, no need to calculate).
- Candidate A = charlles.evangelista, color: `--color-candidate-a` (blue). Candidate B = delegadasheila, color: `--color-candidate-b` (rose). These CSS variables are defined in `globals.css` from Story 2.1.
- The `POST /api/v1/scraping/run` endpoint returns `202 Accepted` and may also return `409 Conflict` if a run is already in progress. Handle 409 gracefully (show "Coleta ja em andamento").

---

## Risks

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Overview API endpoint not yet deployed or returning unexpected shape | Medium | High | Validate API contract against architecture.md; use mock data during development until backend is available |
| `triggerScraping()` POST returns 409 (already in progress) not handled gracefully | Medium | Low | AC7/AC8 mention the trigger but 409 handling is documented in Dev Notes; dev must implement the 409 case |
| CandidateFilter URL param integration depends on Story 2.1 implementation details | Low | Medium | Story 2.1 is a prerequisite; verify search param key name matches before integration |
| Skeleton components may cause layout shift if dimensions don't match final cards | Low | Low | Use fixed-height skeleton cards matching the metric card dimensions |

---

## Validation

| Date | Validator | Score | Verdict | Notes |
|------|-----------|-------|---------|-------|
| 2026-02-21 | Pax (PO) | 9/10 | GO | Missing Risks section was only failure; added during validation. All ACs testable, scope clear, API contract verified against architecture.md |

---

## File List

| File | Action | Description |
|------|--------|-------------|
| `src/components/dashboard/sentiment-badge.tsx` | Created | Green/red/gray badge based on sentiment score thresholds |
| `src/components/dashboard/sentiment-bar.tsx` | Created | Horizontal progress bars for pos/neg/neutral distribution |
| `src/components/dashboard/metric-card.tsx` | Created | Per-candidate metrics card using shadcn Card |
| `src/components/dashboard/summary-row.tsx` | Created | Aggregate totals row (comments, avg sentiment, last scrape) |
| `src/app/overview/page.tsx` | Modified | Server Component wrapper with Suspense boundary |
| `src/app/overview/overview-content.tsx` | Created | Client Component with useOverview integration, all states |
| `src/lib/utils.ts` | Modified | Added formatDate, formatDateShort, formatDateMedium, getCandidateId utilities |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story created | River (SM Agent) |
| 2026-02-21 | 1.1 | Validated: GO 9/10. Added Risks and Validation sections. Status Draft -> Ready | Pax (PO Agent) |
| 2026-02-21 | 1.2 | Implementation complete. All ACs met. Build passes. Status Ready -> InProgress | Dex (Dev Agent) |
