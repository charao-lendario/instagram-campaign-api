# Story 2.2: API Client & Data Fetching

## Status: Draft

## Epic: EPIC-2 - Frontend Dashboard
## Story Points: 5

---

## Story

**As a** frontend developer,
**I want** a typed API client module and reusable data-fetching hooks for every backend endpoint,
**so that** all dashboard views (Stories 2.3 through 2.8) fetch data consistently with proper TypeScript types, loading states, and error handling without duplicating fetch logic.

**PRD References**: FR-006, FR-007, FR-008, FR-009, FR-010, FR-011, FR-012, NFR-001

---

## Acceptance Criteria

- [ ] AC1: Given `src/lib/api.ts`, when imported, then it exports typed async functions for all 9 backend endpoints: `fetchOverview`, `fetchSentimentTimeline`, `fetchWordCloud`, `fetchThemes`, `fetchPosts`, `fetchComparison`, `fetchSuggestions`, `triggerScraping`, and `fetchHealth`.
- [ ] AC2: Given `src/lib/types.ts`, when a developer imports types, then TypeScript interfaces are defined that exactly match the backend Pydantic response schemas (shapes documented in AC-specific section below).
- [ ] AC3: Given `src/hooks/use-overview.ts` (and equivalent hooks for each endpoint), when a component calls `useOverview()`, then the hook returns `{ data: OverviewData | null, loading: boolean, error: Error | null, refetch: () => void }`.
- [ ] AC4: Given a custom hook is called, when the API call is in-flight, then `loading` is `true` and `data` is `null`.
- [ ] AC5: Given a custom hook is called, when the API returns a non-2xx status, then `error` is an `Error` instance with a message including the status code, and `loading` is `false`.
- [ ] AC6: Given `src/components/shared/error-message.tsx`, when rendered with an `error` prop, then it displays a user-friendly message (not raw error text) and a "Try again" button that triggers `refetch`.
- [ ] AC7: Given `src/components/shared/loading-skeleton.tsx`, when rendered with a `variant` prop (`"card" | "chart" | "table" | "text"`), then it renders an appropriate shimmer placeholder matching that variant's shape.
- [ ] AC8: Given `src/components/shared/empty-state.tsx`, when rendered with a `message` and optional `actionLabel` and `onAction` props, then it renders the message and optionally a CTA button.
- [ ] AC9: Given all hooks, when the `NEXT_PUBLIC_API_URL` env var is set, then all fetch calls use it as the base URL without hardcoding any URL.
- [ ] AC10: Given `src/hooks/use-overview.ts`, `src/hooks/use-sentiment-timeline.ts`, and `src/hooks/use-health.ts`, when unit tests run with `pnpm test`, then tests verify loading state, error state (mocked failed fetch), and success state (mocked response) pass for all 3 hooks.

---

## Scope

### IN
- `src/lib/api.ts` — typed API client functions (9 functions)
- `src/lib/types.ts` — TypeScript interfaces matching all backend response schemas
- 8 custom hooks in `src/hooks/` (one per major data domain)
- 3 shared components: `ErrorMessage`, `LoadingSkeleton`, `EmptyState`
- Unit tests for 3 hooks (overview, sentiment-timeline, health)
- Jest + React Testing Library setup (`pnpm add -D jest @testing-library/react @testing-library/jest-dom jest-environment-jsdom ts-jest`)

### OUT
- Any UI rendering beyond the 3 shared utility components (page views are Stories 2.3+)
- SWR or React Query integration (plain fetch + hooks per PRD 12.4)
- API pagination logic beyond simple offset/limit params
- Authentication headers (not required for MVP)

---

## Dependencies

- Story 2.1 must be complete (project scaffolding, `NEXT_PUBLIC_API_URL` env var)
- Epic 1 API endpoints must be deployed or running locally for manual verification

---

## Technical Notes

### API Endpoint Reference (from `docs/architecture/architecture.md` section 3.2)

| Function | Method | Endpoint | Query Params |
|----------|--------|----------|-------------|
| `fetchOverview` | GET | `/api/v1/analytics/overview` | none |
| `fetchSentimentTimeline` | GET | `/api/v1/analytics/sentiment-timeline` | `candidate_id?`, `start_date?`, `end_date?` |
| `fetchWordCloud` | GET | `/api/v1/analytics/wordcloud` | `candidate_id?` |
| `fetchThemes` | GET | `/api/v1/analytics/themes` | `candidate_id?` |
| `fetchPosts` | GET | `/api/v1/analytics/posts` | `candidate_id?`, `sort_by?`, `order?`, `limit?`, `offset?` |
| `fetchComparison` | GET | `/api/v1/analytics/comparison` | none |
| `fetchSuggestions` | POST | `/api/v1/analytics/suggestions` | body: `{ candidate_id?: string }` |
| `triggerScraping` | POST | `/api/v1/scraping/run` | none |
| `fetchHealth` | GET | `/health` | none |

### TypeScript Interface Shapes

All interfaces go in `src/lib/types.ts`. Key shapes (derived from architecture.md section 3.2):

```typescript
// Candidate summary used in overview and comparison
interface CandidateMetrics {
  candidate_id: string
  username: string
  display_name: string
  total_posts: number
  total_comments: number
  average_sentiment_score: number
  sentiment_distribution: { positive: number; negative: number; neutral: number }
  total_engagement: number
}

interface OverviewData {
  candidates: CandidateMetrics[]
  last_scrape: string | null
  total_comments_analyzed: number
}

interface TimelineDataPoint {
  candidate_id: string
  candidate_username: string
  post_id: string
  post_url: string
  post_caption: string
  posted_at: string
  average_sentiment_score: number
  comment_count: number
}

interface SentimentTimelineData {
  data_points: TimelineDataPoint[]
}

interface WordCloudWord { word: string; count: number }
interface WordCloudData { words: WordCloudWord[]; total_unique_words: number }

interface ThemeByCandidate { candidate_id: string; username: string; count: number }
interface ThemeData {
  theme: string; count: number; percentage: number
  by_candidate: ThemeByCandidate[]
}
interface ThemesResponse { themes: ThemeData[] }

interface PostData {
  post_id: string; candidate_username: string; url: string; caption: string
  posted_at: string; like_count: number; comment_count: number
  positive_ratio: number; negative_ratio: number; average_sentiment_score: number
}
interface PostsResponse { posts: PostData[]; total: number; limit: number; offset: number }

interface TrendData {
  direction: 'improving' | 'declining' | 'stable'
  recent_avg: number; previous_avg: number; delta: number
}
interface CandidateComparison extends CandidateMetrics {
  top_themes: Array<{ theme: string; count: number }>
  trend: TrendData
}
interface ComparisonData { candidates: CandidateComparison[] }

interface Suggestion {
  title: string; description: string
  supporting_data: string; priority: 'high' | 'medium' | 'low'
}
interface SuggestionsResponse {
  suggestions: Suggestion[]; generated_at: string
  data_snapshot: { total_comments_analyzed: number; last_scrape: string | null }
}

interface ScrapingRunStatus { run_id: string; status: string; message: string }
interface HealthStatus {
  status: 'ok' | 'degraded'; database: string
  scheduler: string; last_scrape: string | null
}
```

### Hook Pattern

All hooks follow this exact pattern (DRY: extract to a `useApiData` generic base hook):

```typescript
// src/hooks/use-overview.ts
'use client'
import { useState, useEffect, useCallback } from 'react'
import { fetchOverview } from '@/lib/api'
import type { OverviewData } from '@/lib/types'

export function useOverview() {
  const [data, setData] = useState<OverviewData | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<Error | null>(null)

  const refetch = useCallback(async () => {
    setLoading(true)
    setError(null)
    try {
      const result = await fetchOverview()
      setData(result)
    } catch (err) {
      setError(err instanceof Error ? err : new Error('Unknown error'))
    } finally {
      setLoading(false)
    }
  }, [])

  useEffect(() => { refetch() }, [refetch])

  return { data, loading, error, refetch }
}
```

Parameterized hooks (timeline, posts) accept params as arguments and re-fetch when params change.

### Hooks to Create

| Hook File | Wraps | Parameters |
|-----------|-------|------------|
| `use-overview.ts` | `fetchOverview` | none |
| `use-sentiment-timeline.ts` | `fetchSentimentTimeline` | `candidateId?: string, startDate?: string, endDate?: string` |
| `use-word-cloud.ts` | `fetchWordCloud` | `candidateId?: string` |
| `use-themes.ts` | `fetchThemes` | `candidateId?: string` |
| `use-posts.ts` | `fetchPosts` | `candidateId?: string, sortBy?: string, order?: string` |
| `use-comparison.ts` | `fetchComparison` | none |
| `use-suggestions.ts` | `fetchSuggestions` | `candidateId?: string` |
| `use-health.ts` | `fetchHealth` | none |

### Shared Components

**`LoadingSkeleton`** — accepts `variant: "card" | "chart" | "table" | "text"` and renders shimmer using shadcn `Skeleton` component.

**`ErrorMessage`** — accepts `error: Error`, `onRetry?: () => void`. Shows a bordered box with error icon (use emoji or Lucide icon), a friendly message like "Nao foi possivel carregar os dados.", and optionally a "Tentar novamente" button.

**`EmptyState`** — accepts `message: string`, `actionLabel?: string`, `onAction?: () => void`. Shows centered message with optional CTA.

### Error Handling in `api.ts`

```typescript
export async function fetchOverview(): Promise<OverviewData> {
  const res = await fetch(`${API_BASE_URL}/api/v1/analytics/overview`)
  if (!res.ok) throw new Error(`API error: ${res.status} ${res.statusText}`)
  return res.json() as Promise<OverviewData>
}
```

### Testing Setup

Add to `package.json`:
```json
"scripts": { "test": "jest --passWithNoTests" }
```

Jest config (`jest.config.ts`):
```typescript
import type { Config } from 'jest'
const config: Config = {
  testEnvironment: 'jsdom',
  setupFilesAfterFramework: ['<rootDir>/jest.setup.ts'],
  moduleNameMapper: { '^@/(.*)$': '<rootDir>/src/$1' },
  transform: { '^.+\\.tsx?$': ['ts-jest', {}] }
}
export default config
```

Test structure (`src/hooks/__tests__/use-overview.test.ts`):
- Mock global `fetch`
- Test: loading=true while fetching
- Test: data populated on success (mock 200 response)
- Test: error set on failure (mock rejected fetch)
- Test: refetch re-triggers the fetch

---

## Tasks / Subtasks

- [ ] T1: Set up Jest and React Testing Library (AC10)
  - [ ] T1.1: Install dev dependencies: jest, @testing-library/react, @testing-library/jest-dom, jest-environment-jsdom, ts-jest
  - [ ] T1.2: Create `jest.config.ts` and `jest.setup.ts`
  - [ ] T1.3: Add test script to `package.json`

- [ ] T2: Create TypeScript type definitions (AC2)
  - [ ] T2.1: Create `src/lib/types.ts` with all interfaces listed in Dev Notes
  - [ ] T2.2: Export all types from the file

- [ ] T3: Create API client (AC1, AC9)
  - [ ] T3.1: Create `src/lib/api.ts` importing `API_BASE_URL` from constants
  - [ ] T3.2: Implement all 9 fetch functions with proper typing and error throwing

- [ ] T4: Create shared components (AC6, AC7, AC8)
  - [ ] T4.1: Create `src/components/shared/loading-skeleton.tsx` with 4 variants
  - [ ] T4.2: Create `src/components/shared/error-message.tsx` with retry button
  - [ ] T4.3: Create `src/components/shared/empty-state.tsx` with optional CTA

- [ ] T5: Create all custom hooks (AC3, AC4, AC5)
  - [ ] T5.1: Create a generic `useApiData` base hook (optional, for DRY)
  - [ ] T5.2: Create all 8 hooks listed in Dev Notes
  - [ ] T5.3: Ensure parameterized hooks re-fetch when parameters change (useEffect deps)

- [ ] T6: Write unit tests (AC10)
  - [ ] T6.1: Test `useOverview` — loading, success, error states
  - [ ] T6.2: Test `useSentimentTimeline` — loading, success, error states
  - [ ] T6.3: Test `useHealth` — loading, success, error states
  - [ ] T6.4: Run `pnpm test` and ensure all pass

---

## Dev Notes

### Testing
- Framework: Jest + React Testing Library
- Test files: `src/hooks/__tests__/*.test.ts`
- Mock pattern: `global.fetch = jest.fn().mockResolvedValueOnce({ ok: true, json: () => Promise.resolve(mockData) })`
- Minimum: 3 hooks tested per AC10

### Notes from Architecture
- No external state management (no Redux, no Zustand) per PRD 12.4 and architecture decision table section 1.3.
- Plain `fetch` + `useState`/`useEffect` is the approved pattern.
- `NEXT_PUBLIC_API_URL` is the only env var required on the frontend (architecture.md section 8.4).
- All hooks must be Client Components (add `"use client"` at top of hook files) since they use `useState`/`useEffect`.
- API base URL available from `src/lib/constants.ts` (created in Story 2.1): `export const API_BASE_URL = process.env.NEXT_PUBLIC_API_URL ?? 'http://localhost:8000'`

---

## File List

_To be populated by dev agent during implementation._

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-21 | 1.0 | Story created | River (SM Agent) |
